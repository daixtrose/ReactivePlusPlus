\hypertarget{take__until_8hpp_source}{}\doxysection{take\+\_\+until.\+hpp}
\label{take__until_8hpp_source}\index{src/rpp/rpp/operators/take\_until.hpp@{src/rpp/rpp/operators/take\_until.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{//                  ReactivePlusPlus library}}
\DoxyCodeLine{2 \textcolor{comment}{//}}
\DoxyCodeLine{3 \textcolor{comment}{//          Copyright Aleksey Loginov 2022 -\/ present.}}
\DoxyCodeLine{4 \textcolor{comment}{//                    TC Wang 2022 -\/ present.}}
\DoxyCodeLine{5 \textcolor{comment}{// Distributed under the Boost Software License, Version 1.0.}}
\DoxyCodeLine{6 \textcolor{comment}{//    (See accompanying file LICENSE\_1\_0.txt or copy at}}
\DoxyCodeLine{7 \textcolor{comment}{//          https://www.boost.org/LICENSE\_1\_0.txt)}}
\DoxyCodeLine{8 \textcolor{comment}{//}}
\DoxyCodeLine{9 \textcolor{comment}{// Project home: https://github.com/victimsnino/ReactivePlusPlus}}
\DoxyCodeLine{10 \textcolor{comment}{//}}
\DoxyCodeLine{11 }
\DoxyCodeLine{12 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{13 }
\DoxyCodeLine{14 \textcolor{preprocessor}{\#include <rpp/operators/lift.hpp>}                          \textcolor{comment}{// required due to operator uses lift}}
\DoxyCodeLine{15 \textcolor{preprocessor}{\#include <rpp/operators/merge.hpp>}}
\DoxyCodeLine{16 \textcolor{preprocessor}{\#include <rpp/operators/details/subscriber\_with\_state.hpp>} \textcolor{comment}{// create\_subscriber\_with\_state}}
\DoxyCodeLine{17 \textcolor{preprocessor}{\#include <rpp/operators/fwd/take\_until.hpp>}}
\DoxyCodeLine{18 \textcolor{preprocessor}{\#include <rpp/subscribers/constraints.hpp>}}
\DoxyCodeLine{19 \textcolor{preprocessor}{\#include <rpp/utils/functors.hpp>}}
\DoxyCodeLine{20 \textcolor{preprocessor}{\#include <rpp/utils/spinlock.hpp>}}
\DoxyCodeLine{21 }
\DoxyCodeLine{22 IMPLEMENTATION\_FILE(take\_until\_tag);}
\DoxyCodeLine{23 }
\DoxyCodeLine{24 \textcolor{keyword}{namespace }rpp::details}
\DoxyCodeLine{25 \{}
\DoxyCodeLine{26 \textcolor{keyword}{using }take\_until\_state = early\_unsubscribe\_state;}
\DoxyCodeLine{27 }
\DoxyCodeLine{28 \textcolor{keyword}{using }take\_until\_on\_next      = merge\_forwarding\_on\_next;}
\DoxyCodeLine{29 \textcolor{keyword}{using }take\_until\_on\_error     = merge\_on\_error;}
\DoxyCodeLine{30 \textcolor{keyword}{using }take\_until\_on\_completed = early\_unsubscribe\_on\_completed;}
\DoxyCodeLine{31 }
\DoxyCodeLine{32 }
\DoxyCodeLine{36 \textcolor{keyword}{struct }\mbox{\hyperlink{structrpp_1_1details_1_1take__until__throttler__on__next}{take\_until\_throttler\_on\_next}}}
\DoxyCodeLine{37 \{}
\DoxyCodeLine{38     \textcolor{keywordtype}{void} operator()(\textcolor{keyword}{auto}\&\&, \textcolor{keyword}{const} \textcolor{keyword}{auto}\& subscriber, \textcolor{keyword}{const} std::shared\_ptr<take\_until\_state>\& state)\textcolor{keyword}{ const}}
\DoxyCodeLine{39 \textcolor{keyword}{    }\{}
\DoxyCodeLine{40         \textcolor{comment}{// Unsubscribe all sources due to we obtained "{}stop event"{}}}
\DoxyCodeLine{41         state-\/>children\_subscriptions.unsubscribe();}
\DoxyCodeLine{42         subscriber.on\_completed();}
\DoxyCodeLine{43     \}}
\DoxyCodeLine{44 \};}
\DoxyCodeLine{45 }
\DoxyCodeLine{46 \textcolor{keyword}{using }\mbox{\hyperlink{structrpp_1_1details_1_1early__unsubscribe__on__error}{take\_until\_throttler\_on\_error}}     = \mbox{\hyperlink{structrpp_1_1details_1_1early__unsubscribe__on__error}{take\_until\_on\_error}};}
\DoxyCodeLine{47 \textcolor{keyword}{using }\mbox{\hyperlink{structrpp_1_1details_1_1early__unsubscribe__on__completed}{take\_until\_throttler\_on\_completed}} = \mbox{\hyperlink{structrpp_1_1details_1_1early__unsubscribe__on__completed}{take\_until\_on\_completed}};}
\DoxyCodeLine{48 }
\DoxyCodeLine{49 \textcolor{keyword}{struct }\mbox{\hyperlink{structrpp_1_1details_1_1take__until__state__with__serialized__spinlock}{take\_until\_state\_with\_serialized\_spinlock}} : \mbox{\hyperlink{structrpp_1_1details_1_1early__unsubscribe__state}{take\_until\_state}}}
\DoxyCodeLine{50 \{}
\DoxyCodeLine{51     \textcolor{keyword}{using }take\_until\_state::take\_until\_state;}
\DoxyCodeLine{52 }
\DoxyCodeLine{53     \textcolor{comment}{// we can use spinlock there because 99.9\% of time only one ever thread would send values from on\_next (main observable), but we have small probability to get error from "{}until observable"{} immediately}}
\DoxyCodeLine{54     utils::spinlock spinlock\{\};}
\DoxyCodeLine{55 \};}
\DoxyCodeLine{59 \textcolor{keyword}{template}<constra\textcolor{keywordtype}{int}::decayed\_type Type, constra\textcolor{keywordtype}{int}::observable TTriggerObservable>}
\DoxyCodeLine{60 \textcolor{keyword}{struct }\mbox{\hyperlink{structrpp_1_1details_1_1take__until__impl}{take\_until\_impl}}}
\DoxyCodeLine{61 \{}
\DoxyCodeLine{62     \textcolor{keyword}{using }TriggerType = utils::extract\_observable\_type\_t<TTriggerObservable>;}
\DoxyCodeLine{63 }
\DoxyCodeLine{64     TTriggerObservable m\_until\_observable;}
\DoxyCodeLine{65 }
\DoxyCodeLine{66     \textcolor{keyword}{template}<constra\textcolor{keywordtype}{int}::subscriber\_of\_type<Type> TSub>}
\DoxyCodeLine{67     \textcolor{keyword}{auto} operator()(TSub\&\& in\_subscriber)\textcolor{keyword}{ const}}
\DoxyCodeLine{68 \textcolor{keyword}{    }\{}
\DoxyCodeLine{69         \textcolor{keyword}{auto} state = std::make\_shared<take\_until\_state\_with\_serialized\_spinlock>(in\_subscriber.get\_subscription());}
\DoxyCodeLine{70         \textcolor{comment}{// change subscriber to serialized to avoid manual using of mutex}}
\DoxyCodeLine{71         \textcolor{keyword}{auto} subscriber = make\_serialized\_subscriber(std::forward<TSub>(in\_subscriber), std::shared\_ptr<utils::spinlock>\{state, \&state-\/>spinlock\});}
\DoxyCodeLine{72 }
\DoxyCodeLine{73         \textcolor{comment}{// Subscribe to trigger observable}}
\DoxyCodeLine{74         m\_until\_observable.subscribe(create\_subscriber\_with\_state<TriggerType>(state-\/>children\_subscriptions.make\_child(),}
\DoxyCodeLine{75                                                                                \mbox{\hyperlink{structrpp_1_1details_1_1take__until__throttler__on__next}{take\_until\_throttler\_on\_next}}\{\},}
\DoxyCodeLine{76                                                                                \mbox{\hyperlink{structrpp_1_1details_1_1early__unsubscribe__on__error}{take\_until\_throttler\_on\_error}}\{\},}
\DoxyCodeLine{77                                                                                \mbox{\hyperlink{structrpp_1_1details_1_1early__unsubscribe__on__completed}{take\_until\_throttler\_on\_completed}}\{\},}
\DoxyCodeLine{78                                                                                subscriber,}
\DoxyCodeLine{79                                                                                state));}
\DoxyCodeLine{80 }
\DoxyCodeLine{81         \textcolor{keyword}{auto} subscription = state-\/>children\_subscriptions.make\_child();}
\DoxyCodeLine{82         \textcolor{keywordflow}{return} create\_subscriber\_with\_state<Type>(std::move(subscription),}
\DoxyCodeLine{83                                                   take\_until\_on\_next\{\},}
\DoxyCodeLine{84                                                   \mbox{\hyperlink{structrpp_1_1details_1_1early__unsubscribe__on__error}{take\_until\_on\_error}}\{\},}
\DoxyCodeLine{85                                                   \mbox{\hyperlink{structrpp_1_1details_1_1early__unsubscribe__on__completed}{take\_until\_on\_completed}}\{\},}
\DoxyCodeLine{86                                                   std::move(subscriber),}
\DoxyCodeLine{87                                                   std::move(state));}
\DoxyCodeLine{88     \}}
\DoxyCodeLine{89 \};}
\DoxyCodeLine{90 }
\DoxyCodeLine{91 \} \textcolor{comment}{// namespace rpp::details}}

\end{DoxyCode}
