\hypertarget{connectable__observable_8hpp_source}{}\doxysection{connectable\+\_\+observable.\+hpp}
\label{connectable__observable_8hpp_source}\index{src/rpp/rpp/observables/connectable\_observable.hpp@{src/rpp/rpp/observables/connectable\_observable.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{//                   ReactivePlusPlus library}}
\DoxyCodeLine{2 \textcolor{comment}{// }}
\DoxyCodeLine{3 \textcolor{comment}{//           Copyright Aleksey Loginov 2022 -\/ present.}}
\DoxyCodeLine{4 \textcolor{comment}{//  Distributed under the Boost Software License, Version 1.0.}}
\DoxyCodeLine{5 \textcolor{comment}{//     (See accompanying file LICENSE\_1\_0.txt or copy at}}
\DoxyCodeLine{6 \textcolor{comment}{//           https://www.boost.org/LICENSE\_1\_0.txt)}}
\DoxyCodeLine{7 \textcolor{comment}{// }}
\DoxyCodeLine{8 \textcolor{comment}{//  Project home: https://github.com/victimsnino/ReactivePlusPlus}}
\DoxyCodeLine{9 }
\DoxyCodeLine{10 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{11 }
\DoxyCodeLine{12 \textcolor{preprocessor}{\#include <rpp/observables/constraints.hpp>}              \textcolor{comment}{// OriginalObservable type}}
\DoxyCodeLine{13 \textcolor{preprocessor}{\#include <rpp/operators/fwd/ref\_count.hpp>}              \textcolor{comment}{// include forwarding for member\_overload}}
\DoxyCodeLine{14 \textcolor{preprocessor}{\#include <rpp/subjects/constraints.hpp>}                 \textcolor{comment}{// type of subject used}}
\DoxyCodeLine{15 \textcolor{preprocessor}{\#include <rpp/subjects/type\_traits.hpp>}                 \textcolor{comment}{// deduce observable type by subject type}}
\DoxyCodeLine{16 \textcolor{preprocessor}{\#include <rpp/subscriptions/composite\_subscription.hpp>} \textcolor{comment}{// lifetime}}
\DoxyCodeLine{17 \textcolor{preprocessor}{\#include <rpp/defs.hpp>}                                 \textcolor{comment}{// RPP\_EMPTY\_BASES}}
\DoxyCodeLine{18 }
\DoxyCodeLine{19 \textcolor{preprocessor}{\#include <rpp/operators/details/subscriber\_with\_state.hpp>} \textcolor{comment}{// create\_subscriber\_with\_state}}
\DoxyCodeLine{20 }
\DoxyCodeLine{21 }
\DoxyCodeLine{22 \textcolor{preprocessor}{\#include <memory>}}
\DoxyCodeLine{23 \textcolor{preprocessor}{\#include <mutex>}}
\DoxyCodeLine{24 }
\DoxyCodeLine{25 \textcolor{keyword}{namespace }rpp}
\DoxyCodeLine{26 \{}
\DoxyCodeLine{35 \textcolor{keyword}{template}<constraint::decayed\_type                    Type,}
\DoxyCodeLine{36          subjects::constraint::subject\_of\_type<Type> Subject,}
\DoxyCodeLine{37          constraint::observable\_of\_type<Type>        OriginalObservable>}
\DoxyCodeLine{38 \textcolor{keyword}{class }RPP\_EMPTY\_BASES \mbox{\hyperlink{classrpp_1_1connectable__observable}{connectable\_observable}}}
\DoxyCodeLine{39     : \textcolor{keyword}{public} decltype(std::declval<Subject>().get\_observable())}
\DoxyCodeLine{40     , \textcolor{keyword}{public} \mbox{\hyperlink{structrpp_1_1details_1_1member__overload}{details::member\_overload}}<Type, connectable\_observable<Type, Subject, OriginalObservable>, details::ref\_count\_tag>}
\DoxyCodeLine{41 \{}
\DoxyCodeLine{42     \textcolor{keyword}{using }base = \textcolor{keyword}{decltype}(std::declval<Subject>().get\_observable());}
\DoxyCodeLine{43 \textcolor{keyword}{public}:}
\DoxyCodeLine{44     \mbox{\hyperlink{classrpp_1_1connectable__observable}{connectable\_observable}}(\textcolor{keyword}{const} OriginalObservable\& original\_observable, \textcolor{keyword}{const} Subject\& subject = Subject\{\})}
\DoxyCodeLine{45         : base\{subject.get\_observable()\}}
\DoxyCodeLine{46         , m\_original\_observable\{original\_observable\}}
\DoxyCodeLine{47         , m\_state\{std::make\_shared<state\_t>(subject)\} \{\}}
\DoxyCodeLine{48 }
\DoxyCodeLine{49     \mbox{\hyperlink{classrpp_1_1connectable__observable}{connectable\_observable}}(OriginalObservable\&\& original\_observable, \textcolor{keyword}{const} Subject\& subject = Subject\{\})}
\DoxyCodeLine{50         : base\{subject.get\_observable()\}}
\DoxyCodeLine{51         , m\_original\_observable\{std::move(original\_observable)\}}
\DoxyCodeLine{52         , m\_state\{std::make\_shared<state\_t>(subject)\} \{\}}
\DoxyCodeLine{53 }
\DoxyCodeLine{54     \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}} connect(\textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\& subscription = \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\{\}) \textcolor{keyword}{const}}
\DoxyCodeLine{55     \{}
\DoxyCodeLine{56         \textcolor{keyword}{auto}        subscriber              = m\_state-\/>subject.get\_subscriber();}
\DoxyCodeLine{57         \textcolor{keyword}{const} \textcolor{keyword}{auto}\& subscriber\_subscription = subscriber.get\_subscription();}
\DoxyCodeLine{58         }
\DoxyCodeLine{59         \{}
\DoxyCodeLine{60             std::lock\_guard lock(m\_state-\/>mutex);}
\DoxyCodeLine{61 }
\DoxyCodeLine{62             \textcolor{keywordflow}{if} (!m\_state-\/>sub.is\_empty())}
\DoxyCodeLine{63                 \textcolor{keywordflow}{return} subscription;}
\DoxyCodeLine{64 }
\DoxyCodeLine{65             subscriber\_subscription.add(subscription);}
\DoxyCodeLine{66             m\_state-\/>sub = subscription;}
\DoxyCodeLine{67         \}}
\DoxyCodeLine{68 }
\DoxyCodeLine{69         subscription.add([state = std::weak\_ptr\{m\_state\}]}
\DoxyCodeLine{70         \{}
\DoxyCodeLine{71             \textcolor{keywordflow}{if} (\textcolor{keyword}{const} \textcolor{keyword}{auto} locked = state.lock())}
\DoxyCodeLine{72             \{}
\DoxyCodeLine{73                 auto current\_sub = composite\_subscription::empty();}
\DoxyCodeLine{74                 \{}
\DoxyCodeLine{75                     std::lock\_guard lock(locked-\/>mutex);}
\DoxyCodeLine{76                     std::swap(current\_sub, locked-\/>sub);}
\DoxyCodeLine{77                 \}}
\DoxyCodeLine{78                 current\_sub.unsubscribe();}
\DoxyCodeLine{79                 locked-\/>subject.get\_subscriber().get\_subscription().remove(current\_sub);}
\DoxyCodeLine{80             \}}
\DoxyCodeLine{81         \});}
\DoxyCodeLine{82 }
\DoxyCodeLine{83 }
\DoxyCodeLine{84         m\_original\_observable.subscribe(create\_subscriber\_with\_state<Type>(m\_state-\/>sub,}
\DoxyCodeLine{85                                                                                   utils::forwarding\_on\_next\{\},}
\DoxyCodeLine{86                                                                                   utils::forwarding\_on\_error\{\},}
\DoxyCodeLine{87                                                                                   utils::forwarding\_on\_completed\{\},}
\DoxyCodeLine{88                                                                                   subscriber.get\_observer(),}
\DoxyCodeLine{89                                                                                   \textcolor{comment}{// capture state to be sure that state is alive while ANY subscriber is alive}}
\DoxyCodeLine{90                                                                                   m\_state));}
\DoxyCodeLine{91 }
\DoxyCodeLine{92         \textcolor{keywordflow}{return} subscription;}
\DoxyCodeLine{93     \}}
\DoxyCodeLine{94 }
\DoxyCodeLine{95 \textcolor{keyword}{private}:}
\DoxyCodeLine{96     OriginalObservable     m\_original\_observable;}
\DoxyCodeLine{97     \textcolor{keyword}{struct }state\_t}
\DoxyCodeLine{98     \{}
\DoxyCodeLine{99         state\_t(\textcolor{keyword}{const} Subject\& subj) : subject\{subj\} \{\}}
\DoxyCodeLine{100         }
\DoxyCodeLine{101         Subject                subject;}
\DoxyCodeLine{102         std::mutex             mutex\{\};}
\DoxyCodeLine{103         composite\_subscription sub = composite\_subscription::empty();}
\DoxyCodeLine{104     \};}
\DoxyCodeLine{105 }
\DoxyCodeLine{106     std::shared\_ptr<state\_t> m\_state\{\};}
\DoxyCodeLine{107 \};}
\DoxyCodeLine{108 }
\DoxyCodeLine{109 \textcolor{keyword}{template}<constra\textcolor{keywordtype}{int}::observable OriginalObservable, subjects::constra\textcolor{keywordtype}{int}::subject Subject>}
\DoxyCodeLine{110 connectable\_observable(\textcolor{keyword}{const} OriginalObservable\&, \textcolor{keyword}{const} Subject\&) -\/> connectable\_observable<subjects::utils::extract\_subject\_type\_t<Subject>, Subject, OriginalObservable>;}
\DoxyCodeLine{111 \} \textcolor{comment}{// namespace rpp}}

\end{DoxyCode}
