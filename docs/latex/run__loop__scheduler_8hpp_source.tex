\hypertarget{run__loop__scheduler_8hpp_source}{}\doxysection{run\+\_\+loop\+\_\+scheduler.\+hpp}
\label{run__loop__scheduler_8hpp_source}\index{src/rpp/rpp/schedulers/run\_loop\_scheduler.hpp@{src/rpp/rpp/schedulers/run\_loop\_scheduler.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{//                   ReactivePlusPlus library}}
\DoxyCodeLine{2 \textcolor{comment}{// }}
\DoxyCodeLine{3 \textcolor{comment}{//           Copyright Aleksey Loginov 2022 -\/ present.}}
\DoxyCodeLine{4 \textcolor{comment}{//  Distributed under the Boost Software License, Version 1.0.}}
\DoxyCodeLine{5 \textcolor{comment}{//     (See accompanying file LICENSE\_1\_0.txt or copy at}}
\DoxyCodeLine{6 \textcolor{comment}{//           https://www.boost.org/LICENSE\_1\_0.txt)}}
\DoxyCodeLine{7 \textcolor{comment}{// }}
\DoxyCodeLine{8 \textcolor{comment}{//  Project home: https://github.com/victimsnino/ReactivePlusPlus}}
\DoxyCodeLine{9 }
\DoxyCodeLine{10 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{11 }
\DoxyCodeLine{12 \textcolor{preprocessor}{\#include <rpp/schedulers/fwd.hpp>}                       \textcolor{comment}{// own forwarding}}
\DoxyCodeLine{13 \textcolor{preprocessor}{\#include <rpp/schedulers/details/worker.hpp>}            \textcolor{comment}{// worker}}
\DoxyCodeLine{14 \textcolor{preprocessor}{\#include <rpp/subscriptions/composite\_subscription.hpp>} \textcolor{comment}{// lifetime}}
\DoxyCodeLine{15 \textcolor{preprocessor}{\#include <rpp/schedulers/details/queue\_worker\_state.hpp>}\textcolor{comment}{// state}}
\DoxyCodeLine{16 }
\DoxyCodeLine{17 }
\DoxyCodeLine{18 \textcolor{keyword}{namespace }rpp::schedulers}
\DoxyCodeLine{19 \{}
\DoxyCodeLine{29 \textcolor{keyword}{class }\mbox{\hyperlink{classrpp_1_1schedulers_1_1run__loop}{run\_loop}} final : \textcolor{keyword}{public} \mbox{\hyperlink{structrpp_1_1schedulers_1_1details_1_1scheduler__tag}{details::scheduler\_tag}}}
\DoxyCodeLine{30 \{}
\DoxyCodeLine{31 \textcolor{keyword}{private}:}
\DoxyCodeLine{32     \textcolor{keyword}{class }\mbox{\hyperlink{conceptrpp_1_1schedulers_1_1worker__strategy}{worker\_strategy}};}
\DoxyCodeLine{33     \textcolor{keyword}{using }\mbox{\hyperlink{classrpp_1_1schedulers_1_1schedulable__wrapper}{run\_loop\_schedulable}} = \mbox{\hyperlink{classrpp_1_1schedulers_1_1schedulable__wrapper}{schedulable\_wrapper<worker\_strategy>}};}
\DoxyCodeLine{34 }
\DoxyCodeLine{35     \textcolor{keyword}{class }\mbox{\hyperlink{conceptrpp_1_1schedulers_1_1worker__strategy}{worker\_strategy}}}
\DoxyCodeLine{36     \{}
\DoxyCodeLine{37     \textcolor{keyword}{public}:}
\DoxyCodeLine{38         \mbox{\hyperlink{conceptrpp_1_1schedulers_1_1worker__strategy}{worker\_strategy}}(std::weak\_ptr<\mbox{\hyperlink{classrpp_1_1schedulers_1_1details_1_1queue__worker__state}{details::queue\_worker\_state<run\_loop\_schedulable>}}> queue,}
\DoxyCodeLine{39                         \textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\&                                    sub)}
\DoxyCodeLine{40             : m\_queue\{std::move(queue)\}}
\DoxyCodeLine{41             , m\_sub\{sub\}}
\DoxyCodeLine{42         \{\}}
\DoxyCodeLine{43 }
\DoxyCodeLine{44         \textcolor{keywordtype}{bool} is\_subscribed()\textcolor{keyword}{ const}}
\DoxyCodeLine{45 \textcolor{keyword}{        }\{}
\DoxyCodeLine{46             \textcolor{keywordflow}{return} m\_sub.\mbox{\hyperlink{classrpp_1_1subscription__base_ad9c07157024e7f68ce815d971c3faaf2}{is\_subscribed}}();}
\DoxyCodeLine{47         \}}
\DoxyCodeLine{48 }
\DoxyCodeLine{49         \textcolor{keywordtype}{void} defer\_at(time\_point time\_point, \mbox{\hyperlink{conceptrpp_1_1schedulers_1_1constraint_1_1schedulable__fn}{constraint::schedulable\_fn}} \textcolor{keyword}{auto}\&\& fn)\textcolor{keyword}{ const}}
\DoxyCodeLine{50 \textcolor{keyword}{        }\{}
\DoxyCodeLine{51             defer\_at(time\_point, \mbox{\hyperlink{classrpp_1_1schedulers_1_1schedulable__wrapper}{run\_loop\_schedulable}}\{*\textcolor{keyword}{this}, time\_point, std::forward<decltype(fn)>(fn)\});}
\DoxyCodeLine{52         \}}
\DoxyCodeLine{53 }
\DoxyCodeLine{54         \textcolor{keywordtype}{void} defer\_at(time\_point time\_point, \mbox{\hyperlink{classrpp_1_1schedulers_1_1schedulable__wrapper}{run\_loop\_schedulable}}\&\& fn)\textcolor{keyword}{ const}}
\DoxyCodeLine{55 \textcolor{keyword}{        }\{}
\DoxyCodeLine{56             \textcolor{keywordflow}{if} (m\_sub.is\_subscribed())}
\DoxyCodeLine{57                 \textcolor{keywordflow}{if} (\textcolor{keyword}{auto} locked = m\_queue.lock())}
\DoxyCodeLine{58                     locked-\/>emplace(time\_point, std::move(fn));}
\DoxyCodeLine{59         \}}
\DoxyCodeLine{60 }
\DoxyCodeLine{61         \textcolor{keyword}{static} time\_point now() \{ \textcolor{keywordflow}{return} clock\_type::now(); \}}
\DoxyCodeLine{62 }
\DoxyCodeLine{63     \textcolor{keyword}{private}:}
\DoxyCodeLine{64         std::weak\_ptr<details::queue\_worker\_state<run\_loop\_schedulable>> m\_queue\{\};}
\DoxyCodeLine{65         \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}                                           m\_sub\{\};}
\DoxyCodeLine{66     \};}
\DoxyCodeLine{67 }
\DoxyCodeLine{68     \textcolor{keyword}{class }state}
\DoxyCodeLine{69     \{}
\DoxyCodeLine{70     \textcolor{keyword}{public}:}
\DoxyCodeLine{71         state(\textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\& sub = \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\{\})}
\DoxyCodeLine{72             : m\_sub\{sub\} \{ \}}
\DoxyCodeLine{73 }
\DoxyCodeLine{74         state(\textcolor{keyword}{const} state\&)     = \textcolor{keyword}{delete};}
\DoxyCodeLine{75         state(state\&\&) \textcolor{keyword}{noexcept} = \textcolor{keyword}{delete};}
\DoxyCodeLine{76 }
\DoxyCodeLine{77         \string~state()}
\DoxyCodeLine{78         \{}
\DoxyCodeLine{79             m\_queue.\mbox{\hyperlink{classrpp_1_1subscription__base_af07ca7cdfb9758441c0729cbe3e6d19d}{unsubscribe}}();}
\DoxyCodeLine{80             m\_sub.unsubscribe();}
\DoxyCodeLine{81         \}}
\DoxyCodeLine{82 }
\DoxyCodeLine{83         \mbox{\hyperlink{classrpp_1_1schedulers_1_1details_1_1queue__worker__state}{details::queue\_worker\_state<run\_loop\_schedulable>}}\& get\_queue() \{ \textcolor{keywordflow}{return} m\_queue; \}}
\DoxyCodeLine{84         }
\DoxyCodeLine{85         \textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\& get\_subscription()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} m\_sub; \}}
\DoxyCodeLine{86     \textcolor{keyword}{private}:}
\DoxyCodeLine{87         \mbox{\hyperlink{classrpp_1_1composite__subscription}{rpp::composite\_subscription}}                       m\_sub;}
\DoxyCodeLine{88         \mbox{\hyperlink{classrpp_1_1schedulers_1_1details_1_1queue__worker__state}{details::queue\_worker\_state<run\_loop\_schedulable>}} m\_queue\{\};}
\DoxyCodeLine{89     \};}
\DoxyCodeLine{90 }
\DoxyCodeLine{91 \textcolor{keyword}{public}:}
\DoxyCodeLine{92 }
\DoxyCodeLine{93     \mbox{\hyperlink{classrpp_1_1schedulers_1_1run__loop}{run\_loop}}(\textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\& sub = \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\{\})}
\DoxyCodeLine{94         : m\_state(std::make\_shared<state>(sub)) \{\}}
\DoxyCodeLine{95 }
\DoxyCodeLine{96     \textcolor{keyword}{auto} create\_worker(\textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\& sub = \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\{\}) \textcolor{keyword}{const}}
\DoxyCodeLine{97     \{}
\DoxyCodeLine{98         \textcolor{keyword}{auto} res = m\_state-\/>get\_subscription().add(sub);}
\DoxyCodeLine{99         sub.add([weak = std::weak\_ptr\{m\_state\}, res]}
\DoxyCodeLine{100         \{}
\DoxyCodeLine{101             \textcolor{keywordflow}{if} (\textcolor{keyword}{const} \textcolor{keyword}{auto} sh = weak.lock())}
\DoxyCodeLine{102                 sh-\/>get\_subscription().remove(res);}
\DoxyCodeLine{103         \});}
\DoxyCodeLine{104         \textcolor{keywordflow}{return} \mbox{\hyperlink{classrpp_1_1schedulers_1_1worker}{worker<worker\_strategy>}}\{std::shared\_ptr<details::queue\_worker\_state<run\_loop\_schedulable>>\{m\_state, \&m\_state-\/>get\_queue()\}, sub\};}
\DoxyCodeLine{105     \}}
\DoxyCodeLine{106 }
\DoxyCodeLine{107     \textcolor{keywordtype}{bool} is\_empty()\textcolor{keyword}{ const}}
\DoxyCodeLine{108 \textcolor{keyword}{    }\{}
\DoxyCodeLine{109         \textcolor{keywordflow}{return} m\_state-\/>get\_queue().is\_empty();}
\DoxyCodeLine{110     \}}
\DoxyCodeLine{111 }
\DoxyCodeLine{112     \textcolor{keywordtype}{bool} is\_any\_ready\_schedulable()\textcolor{keyword}{ const}}
\DoxyCodeLine{113 \textcolor{keyword}{    }\{}
\DoxyCodeLine{114         \textcolor{keywordflow}{return} m\_state-\/>get\_queue().is\_any\_ready\_schedulable();}
\DoxyCodeLine{115     \}}
\DoxyCodeLine{116 }
\DoxyCodeLine{117     \textcolor{keywordtype}{void} dispatch\_if\_ready()\textcolor{keyword}{ const}}
\DoxyCodeLine{118 \textcolor{keyword}{    }\{}
\DoxyCodeLine{119         std::optional<run\_loop\_schedulable> fn\{\};}
\DoxyCodeLine{120         \textcolor{keywordflow}{if} (m\_state-\/>get\_queue().pop\_if\_ready(fn))}
\DoxyCodeLine{121             (*fn)();}
\DoxyCodeLine{122     \}}
\DoxyCodeLine{123 }
\DoxyCodeLine{124     \textcolor{keywordtype}{void} dispatch()\textcolor{keyword}{ const}}
\DoxyCodeLine{125 \textcolor{keyword}{    }\{}
\DoxyCodeLine{126         std::optional<run\_loop\_schedulable> fn\{\};}
\DoxyCodeLine{127         \textcolor{keywordflow}{if} (m\_state-\/>get\_queue().pop\_with\_wait(fn))}
\DoxyCodeLine{128             (*fn)();}
\DoxyCodeLine{129     \}}
\DoxyCodeLine{130 }
\DoxyCodeLine{131 \textcolor{keyword}{private}:}
\DoxyCodeLine{132     \textcolor{keyword}{const} std::shared\_ptr<state> m\_state\{\};}
\DoxyCodeLine{133 \};}
\DoxyCodeLine{134 \} \textcolor{comment}{// namespace rpp::schedulers}}

\end{DoxyCode}
