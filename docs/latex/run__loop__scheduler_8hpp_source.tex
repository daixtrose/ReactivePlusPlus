\hypertarget{run__loop__scheduler_8hpp_source}{}\doxysection{run\+\_\+loop\+\_\+scheduler.\+hpp}
\label{run__loop__scheduler_8hpp_source}\index{src/rpp/rpp/schedulers/run\_loop\_scheduler.hpp@{src/rpp/rpp/schedulers/run\_loop\_scheduler.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{//                   ReactivePlusPlus library}}
\DoxyCodeLine{2 \textcolor{comment}{// }}
\DoxyCodeLine{3 \textcolor{comment}{//           Copyright Aleksey Loginov 2022 -\/ present.}}
\DoxyCodeLine{4 \textcolor{comment}{//  Distributed under the Boost Software License, Version 1.0.}}
\DoxyCodeLine{5 \textcolor{comment}{//     (See accompanying file LICENSE\_1\_0.txt or copy at}}
\DoxyCodeLine{6 \textcolor{comment}{//           https://www.boost.org/LICENSE\_1\_0.txt)}}
\DoxyCodeLine{7 \textcolor{comment}{// }}
\DoxyCodeLine{8 \textcolor{comment}{//  Project home: https://github.com/victimsnino/ReactivePlusPlus}}
\DoxyCodeLine{9 }
\DoxyCodeLine{10 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{11 }
\DoxyCodeLine{12 \textcolor{preprocessor}{\#include <rpp/schedulers/fwd.hpp>}                       \textcolor{comment}{// own forwarding}}
\DoxyCodeLine{13 \textcolor{preprocessor}{\#include <rpp/schedulers/details/worker.hpp>}            \textcolor{comment}{// worker}}
\DoxyCodeLine{14 \textcolor{preprocessor}{\#include <rpp/subscriptions/composite\_subscription.hpp>} \textcolor{comment}{// lifetime}}
\DoxyCodeLine{15 \textcolor{preprocessor}{\#include <rpp/schedulers/details/queue\_worker\_state.hpp>}\textcolor{comment}{// state}}
\DoxyCodeLine{16 }
\DoxyCodeLine{17 }
\DoxyCodeLine{18 \textcolor{keyword}{namespace }rpp::schedulers}
\DoxyCodeLine{19 \{}
\DoxyCodeLine{29 \textcolor{keyword}{class }\mbox{\hyperlink{classrpp_1_1schedulers_1_1run__loop}{run\_loop}} final : \textcolor{keyword}{public} \mbox{\hyperlink{structrpp_1_1schedulers_1_1details_1_1scheduler__tag}{details::scheduler\_tag}}}
\DoxyCodeLine{30 \{}
\DoxyCodeLine{31 \textcolor{keyword}{private}:}
\DoxyCodeLine{32     \textcolor{keyword}{class }\mbox{\hyperlink{conceptrpp_1_1schedulers_1_1worker__strategy}{worker\_strategy}};}
\DoxyCodeLine{33     \textcolor{keyword}{using }\mbox{\hyperlink{classrpp_1_1schedulers_1_1schedulable__wrapper}{run\_loop\_schedulable}} = \mbox{\hyperlink{classrpp_1_1schedulers_1_1schedulable__wrapper}{schedulable\_wrapper<worker\_strategy>}};}
\DoxyCodeLine{34 }
\DoxyCodeLine{35     \textcolor{keyword}{class }\mbox{\hyperlink{conceptrpp_1_1schedulers_1_1worker__strategy}{worker\_strategy}}}
\DoxyCodeLine{36     \{}
\DoxyCodeLine{37     \textcolor{keyword}{public}:}
\DoxyCodeLine{38         \mbox{\hyperlink{conceptrpp_1_1schedulers_1_1worker__strategy}{worker\_strategy}}(std::weak\_ptr<\mbox{\hyperlink{classrpp_1_1schedulers_1_1details_1_1queue__worker__state}{details::queue\_worker\_state<run\_loop\_schedulable>}}> queue,}
\DoxyCodeLine{39                         \textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\&                                    sub)}
\DoxyCodeLine{40             : m\_queue\{std::move(queue)\}}
\DoxyCodeLine{41             , m\_sub\{sub\}}
\DoxyCodeLine{42         \{\}}
\DoxyCodeLine{43 }
\DoxyCodeLine{44         \textcolor{keywordtype}{bool} is\_subscribed()\textcolor{keyword}{ const}}
\DoxyCodeLine{45 \textcolor{keyword}{        }\{}
\DoxyCodeLine{46             \textcolor{keywordflow}{return} m\_sub.\mbox{\hyperlink{classrpp_1_1subscription__base_ad9c07157024e7f68ce815d971c3faaf2}{is\_subscribed}}();}
\DoxyCodeLine{47         \}}
\DoxyCodeLine{48 }
\DoxyCodeLine{49         \textcolor{keywordtype}{void} defer\_at(time\_point time\_point, \mbox{\hyperlink{conceptrpp_1_1schedulers_1_1constraint_1_1schedulable__fn}{constraint::schedulable\_fn}} \textcolor{keyword}{auto}\&\& fn)\textcolor{keyword}{ const}}
\DoxyCodeLine{50 \textcolor{keyword}{        }\{}
\DoxyCodeLine{51             defer\_at(time\_point, \mbox{\hyperlink{classrpp_1_1schedulers_1_1schedulable__wrapper}{run\_loop\_schedulable}}\{*\textcolor{keyword}{this}, time\_point, std::forward<decltype(fn)>(fn)\});}
\DoxyCodeLine{52         \}}
\DoxyCodeLine{53 }
\DoxyCodeLine{54         \textcolor{keywordtype}{void} defer\_at(time\_point time\_point, \mbox{\hyperlink{classrpp_1_1schedulers_1_1schedulable__wrapper}{run\_loop\_schedulable}}\&\& fn)\textcolor{keyword}{ const}}
\DoxyCodeLine{55 \textcolor{keyword}{        }\{}
\DoxyCodeLine{56             \textcolor{keywordflow}{if} (m\_sub.is\_subscribed())}
\DoxyCodeLine{57                 \textcolor{keywordflow}{if} (\textcolor{keyword}{auto} locked = m\_queue.lock())}
\DoxyCodeLine{58                     locked-\/>emplace(time\_point, std::move(fn));}
\DoxyCodeLine{59         \}}
\DoxyCodeLine{60 }
\DoxyCodeLine{61         \textcolor{keyword}{static} time\_point now() \{ \textcolor{keywordflow}{return} clock\_type::now(); \}}
\DoxyCodeLine{62 }
\DoxyCodeLine{63     \textcolor{keyword}{private}:}
\DoxyCodeLine{64         std::weak\_ptr<details::queue\_worker\_state<run\_loop\_schedulable>> m\_queue\{\};}
\DoxyCodeLine{65         \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}                                           m\_sub\{\};}
\DoxyCodeLine{66     \};}
\DoxyCodeLine{67 }
\DoxyCodeLine{68     \textcolor{keyword}{class }state}
\DoxyCodeLine{69     \{}
\DoxyCodeLine{70     \textcolor{keyword}{public}:}
\DoxyCodeLine{71         state(\textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\& sub = \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\{\})}
\DoxyCodeLine{72             : m\_sub\{sub\} \{ \}}
\DoxyCodeLine{73 }
\DoxyCodeLine{74         state(\textcolor{keyword}{const} state\&)     = \textcolor{keyword}{delete};}
\DoxyCodeLine{75         state(state\&\&) \textcolor{keyword}{noexcept} = \textcolor{keyword}{delete};}
\DoxyCodeLine{76 }
\DoxyCodeLine{77         \string~state()}
\DoxyCodeLine{78         \{}
\DoxyCodeLine{79             m\_source.request\_stop();}
\DoxyCodeLine{80             m\_sub.\mbox{\hyperlink{classrpp_1_1subscription__base_af07ca7cdfb9758441c0729cbe3e6d19d}{unsubscribe}}();}
\DoxyCodeLine{81         \}}
\DoxyCodeLine{82 }
\DoxyCodeLine{83         \mbox{\hyperlink{classrpp_1_1schedulers_1_1details_1_1queue__worker__state}{details::queue\_worker\_state<run\_loop\_schedulable>}}\& get\_queue() \{ \textcolor{keywordflow}{return} m\_queue; \}}
\DoxyCodeLine{84         std::stop\_token                                    get\_token()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} m\_source.get\_token(); \}}
\DoxyCodeLine{85 }
\DoxyCodeLine{86         \textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\& get\_subscription()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} m\_sub; \}}
\DoxyCodeLine{87     \textcolor{keyword}{private}:}
\DoxyCodeLine{88         \mbox{\hyperlink{classrpp_1_1composite__subscription}{rpp::composite\_subscription}}                       m\_sub;}
\DoxyCodeLine{89         \mbox{\hyperlink{classrpp_1_1schedulers_1_1details_1_1queue__worker__state}{details::queue\_worker\_state<run\_loop\_schedulable>}} m\_queue\{\};}
\DoxyCodeLine{90         std::stop\_source                                  m\_source\{\};}
\DoxyCodeLine{91     \};}
\DoxyCodeLine{92 }
\DoxyCodeLine{93 \textcolor{keyword}{public}:}
\DoxyCodeLine{94 }
\DoxyCodeLine{95     \mbox{\hyperlink{classrpp_1_1schedulers_1_1run__loop}{run\_loop}}(\textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\& sub = \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\{\})}
\DoxyCodeLine{96         : m\_state(std::make\_shared<state>(sub)) \{\}}
\DoxyCodeLine{97 }
\DoxyCodeLine{98     \textcolor{keyword}{auto} create\_worker(\textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\& sub = \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\{\}) \textcolor{keyword}{const}}
\DoxyCodeLine{99     \{}
\DoxyCodeLine{100         \textcolor{keyword}{auto} res = m\_state-\/>get\_subscription().add(sub);}
\DoxyCodeLine{101         sub.add([weak = std::weak\_ptr\{m\_state\}, res]}
\DoxyCodeLine{102         \{}
\DoxyCodeLine{103             \textcolor{keywordflow}{if} (\textcolor{keyword}{const} \textcolor{keyword}{auto} sh = weak.lock())}
\DoxyCodeLine{104                 sh-\/>get\_subscription().remove(res);}
\DoxyCodeLine{105         \});}
\DoxyCodeLine{106         \textcolor{keywordflow}{return} \mbox{\hyperlink{classrpp_1_1schedulers_1_1worker}{worker<worker\_strategy>}}\{std::shared\_ptr<details::queue\_worker\_state<run\_loop\_schedulable>>\{m\_state, \&m\_state-\/>get\_queue()\}, sub\};}
\DoxyCodeLine{107     \}}
\DoxyCodeLine{108 }
\DoxyCodeLine{109     \textcolor{keywordtype}{bool} is\_empty()\textcolor{keyword}{ const}}
\DoxyCodeLine{110 \textcolor{keyword}{    }\{}
\DoxyCodeLine{111         \textcolor{keywordflow}{return} m\_state-\/>get\_queue().is\_empty();}
\DoxyCodeLine{112     \}}
\DoxyCodeLine{113 }
\DoxyCodeLine{114     \textcolor{keywordtype}{bool} is\_any\_ready\_schedulable()\textcolor{keyword}{ const}}
\DoxyCodeLine{115 \textcolor{keyword}{    }\{}
\DoxyCodeLine{116         \textcolor{keywordflow}{return} m\_state-\/>get\_queue().is\_any\_ready\_schedulable();}
\DoxyCodeLine{117     \}}
\DoxyCodeLine{118 }
\DoxyCodeLine{119     \textcolor{keywordtype}{void} dispatch\_if\_ready()\textcolor{keyword}{ const}}
\DoxyCodeLine{120 \textcolor{keyword}{    }\{}
\DoxyCodeLine{121         std::optional<run\_loop\_schedulable> fn\{\};}
\DoxyCodeLine{122         \textcolor{keywordflow}{if} (m\_state-\/>get\_queue().pop\_if\_ready(fn))}
\DoxyCodeLine{123             (*fn)();}
\DoxyCodeLine{124     \}}
\DoxyCodeLine{125 }
\DoxyCodeLine{126     \textcolor{keywordtype}{void} dispatch()\textcolor{keyword}{ const}}
\DoxyCodeLine{127 \textcolor{keyword}{    }\{}
\DoxyCodeLine{128         std::optional<run\_loop\_schedulable> fn\{\};}
\DoxyCodeLine{129         \textcolor{keywordflow}{if} (m\_state-\/>get\_queue().pop\_with\_wait(fn, m\_state-\/>get\_token()))}
\DoxyCodeLine{130             (*fn)();}
\DoxyCodeLine{131     \}}
\DoxyCodeLine{132 }
\DoxyCodeLine{133 \textcolor{keyword}{private}:}
\DoxyCodeLine{134     \textcolor{keyword}{const} std::shared\_ptr<state> m\_state\{\};}
\DoxyCodeLine{135 \};}
\DoxyCodeLine{136 \} \textcolor{comment}{// namespace rpp::schedulers}}

\end{DoxyCode}
