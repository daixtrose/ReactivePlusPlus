\hypertarget{trampoline__scheduler_8hpp_source}{}\doxysection{trampoline\+\_\+scheduler.\+hpp}
\label{trampoline__scheduler_8hpp_source}\index{src/rpp/rpp/schedulers/trampoline\_scheduler.hpp@{src/rpp/rpp/schedulers/trampoline\_scheduler.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{//                  ReactivePlusPlus library}}
\DoxyCodeLine{2 \textcolor{comment}{//}}
\DoxyCodeLine{3 \textcolor{comment}{//          Copyright Aleksey Loginov 2022 -\/ present.}}
\DoxyCodeLine{4 \textcolor{comment}{//                            TC Wang 2022 -\/ present.}}
\DoxyCodeLine{5 \textcolor{comment}{// Distributed under the Boost Software License, Version 1.0.}}
\DoxyCodeLine{6 \textcolor{comment}{//    (See accompanying file LICENSE\_1\_0.txt or copy at}}
\DoxyCodeLine{7 \textcolor{comment}{//          https://www.boost.org/LICENSE\_1\_0.txt)}}
\DoxyCodeLine{8 \textcolor{comment}{//}}
\DoxyCodeLine{9 \textcolor{comment}{// Project home: https://github.com/victimsnino/ReactivePlusPlus}}
\DoxyCodeLine{10 \textcolor{comment}{//}}
\DoxyCodeLine{11 }
\DoxyCodeLine{12 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{13 }
\DoxyCodeLine{14 }
\DoxyCodeLine{15 \textcolor{preprocessor}{\#include <rpp/schedulers/fwd.hpp>}                       \textcolor{comment}{// own forwarding}}
\DoxyCodeLine{16 \textcolor{preprocessor}{\#include <rpp/schedulers/details/worker.hpp>}            \textcolor{comment}{// worker}}
\DoxyCodeLine{17 \textcolor{preprocessor}{\#include <rpp/subscriptions/composite\_subscription.hpp>} \textcolor{comment}{// lifetime}}
\DoxyCodeLine{18 \textcolor{preprocessor}{\#include <rpp/schedulers/details/queue\_worker\_state.hpp>}\textcolor{comment}{// state}}
\DoxyCodeLine{19 \textcolor{preprocessor}{\#include <rpp/utils/utilities.hpp>}}
\DoxyCodeLine{20 \textcolor{preprocessor}{\#include <rpp/schedulers/details/utils.hpp>}}
\DoxyCodeLine{21 }
\DoxyCodeLine{22 \textcolor{preprocessor}{\#include <concepts>}}
\DoxyCodeLine{23 \textcolor{preprocessor}{\#include <chrono>}}
\DoxyCodeLine{24 \textcolor{preprocessor}{\#include <functional>}}
\DoxyCodeLine{25 \textcolor{preprocessor}{\#include <thread>}}
\DoxyCodeLine{26 }
\DoxyCodeLine{27 }
\DoxyCodeLine{28 \textcolor{keyword}{namespace }rpp::schedulers}
\DoxyCodeLine{29 \{}
\DoxyCodeLine{38 \textcolor{keyword}{class }\mbox{\hyperlink{classrpp_1_1schedulers_1_1trampoline}{trampoline}} final : \textcolor{keyword}{public} \mbox{\hyperlink{structrpp_1_1schedulers_1_1details_1_1scheduler__tag}{details::scheduler\_tag}}}
\DoxyCodeLine{39 \{}
\DoxyCodeLine{40     \textcolor{keyword}{class }current\_thread\_schedulable;}
\DoxyCodeLine{41     \textcolor{keyword}{class }\mbox{\hyperlink{conceptrpp_1_1schedulers_1_1worker__strategy}{worker\_strategy}};}
\DoxyCodeLine{42 }
\DoxyCodeLine{43     \textcolor{keyword}{using }\mbox{\hyperlink{classrpp_1_1schedulers_1_1schedulable__wrapper}{trampoline\_schedulable}} = \mbox{\hyperlink{classrpp_1_1schedulers_1_1schedulable__wrapper}{schedulable\_wrapper<worker\_strategy>}};}
\DoxyCodeLine{44 }
\DoxyCodeLine{45     \textcolor{keyword}{class }\mbox{\hyperlink{conceptrpp_1_1schedulers_1_1worker__strategy}{worker\_strategy}}}
\DoxyCodeLine{46     \{}
\DoxyCodeLine{47     \textcolor{keyword}{public}:}
\DoxyCodeLine{48         \textcolor{keyword}{explicit} \mbox{\hyperlink{conceptrpp_1_1schedulers_1_1worker__strategy}{worker\_strategy}}(\textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1composite__subscription}{rpp::composite\_subscription}}\& subscription)}
\DoxyCodeLine{49             : m\_sub\{ subscription \} \{\}}
\DoxyCodeLine{50 }
\DoxyCodeLine{51         \textcolor{keywordtype}{bool} is\_subscribed()\textcolor{keyword}{ const}}
\DoxyCodeLine{52 \textcolor{keyword}{        }\{}
\DoxyCodeLine{53             \textcolor{keywordflow}{return} m\_sub.\mbox{\hyperlink{classrpp_1_1subscription__base_ad9c07157024e7f68ce815d971c3faaf2}{is\_subscribed}}();}
\DoxyCodeLine{54         \}}
\DoxyCodeLine{55 }
\DoxyCodeLine{56         \textcolor{keywordtype}{void} defer\_at(time\_point time\_point, \mbox{\hyperlink{conceptrpp_1_1schedulers_1_1constraint_1_1schedulable__fn}{constraint::schedulable\_fn}} \textcolor{keyword}{auto}\&\& fn)\textcolor{keyword}{ const}}
\DoxyCodeLine{57 \textcolor{keyword}{        }\{}
\DoxyCodeLine{58             \textcolor{keywordflow}{if} (!m\_sub.is\_subscribed())}
\DoxyCodeLine{59                 \textcolor{keywordflow}{return};}
\DoxyCodeLine{60 }
\DoxyCodeLine{61             \textcolor{keyword}{const} \textcolor{keywordtype}{bool} someone\_owns\_queue = s\_queue.has\_value();}
\DoxyCodeLine{62 }
\DoxyCodeLine{63             \textcolor{keyword}{const} \textcolor{keyword}{auto} drain\_on\_exit =  utils::finally\_action(!someone\_owns\_queue ? \&drain\_queue : +[]\{\});}
\DoxyCodeLine{64 }
\DoxyCodeLine{65             \textcolor{keywordflow}{if} (!someone\_owns\_queue)}
\DoxyCodeLine{66             \{}
\DoxyCodeLine{67                 s\_queue = std::priority\_queue<current\_thread\_schedulable>\{\};}
\DoxyCodeLine{68 }
\DoxyCodeLine{69                 \textcolor{keywordflow}{if} (!details::immediate\_scheduling\_while\_condition(time\_point, fn, m\_sub, []() \{ \textcolor{keywordflow}{return} s\_queue-\/>empty(); \}))}
\DoxyCodeLine{70                     \textcolor{keywordflow}{return};}
\DoxyCodeLine{71 }
\DoxyCodeLine{72                 \textcolor{comment}{// update time to make it more accurate due to we are going to push it to queue}}
\DoxyCodeLine{73                 time\_point = std::max(now(), time\_point);}
\DoxyCodeLine{74             \}}
\DoxyCodeLine{75 }
\DoxyCodeLine{76             defer\_at(time\_point, \mbox{\hyperlink{classrpp_1_1schedulers_1_1schedulable__wrapper}{trampoline\_schedulable}}\{ *\textcolor{keyword}{this}, time\_point, std::forward<decltype(fn)>(fn) \});}
\DoxyCodeLine{77         \}}
\DoxyCodeLine{78 }
\DoxyCodeLine{79         \textcolor{keywordtype}{void} defer\_at(time\_point time\_point, \mbox{\hyperlink{classrpp_1_1schedulers_1_1schedulable__wrapper}{trampoline\_schedulable}}\&\& fn)\textcolor{keyword}{ const}}
\DoxyCodeLine{80 \textcolor{keyword}{        }\{}
\DoxyCodeLine{81             \textcolor{keywordflow}{if} (!m\_sub.is\_subscribed())}
\DoxyCodeLine{82                 \textcolor{keywordflow}{return};}
\DoxyCodeLine{83 }
\DoxyCodeLine{84             s\_queue-\/>emplace(time\_point, std::move(fn), m\_sub);}
\DoxyCodeLine{85         \}}
\DoxyCodeLine{86 }
\DoxyCodeLine{87         \textcolor{keyword}{static} time\_point now() \{ \textcolor{keywordflow}{return} clock\_type::now(); \}}
\DoxyCodeLine{88 }
\DoxyCodeLine{89     \textcolor{keyword}{private}:}
\DoxyCodeLine{90         \mbox{\hyperlink{classrpp_1_1composite__subscription}{rpp::composite\_subscription}} m\_sub;}
\DoxyCodeLine{91     \};}
\DoxyCodeLine{92 }
\DoxyCodeLine{93     \textcolor{keyword}{static} \textcolor{keywordtype}{void} drain\_queue()}
\DoxyCodeLine{94     \{}
\DoxyCodeLine{95         \textcolor{keywordflow}{if} (!s\_queue.has\_value())}
\DoxyCodeLine{96             \textcolor{keywordflow}{return};}
\DoxyCodeLine{97 }
\DoxyCodeLine{98         \textcolor{keyword}{auto}  reset\_at\_final = utils::finally\_action\{ [] \{ s\_queue.reset(); \} \};}
\DoxyCodeLine{99         std::optional<trampoline\_schedulable> function\{\};}
\DoxyCodeLine{100 }
\DoxyCodeLine{101         \textcolor{keywordflow}{while} (!s\_queue-\/>empty())}
\DoxyCodeLine{102         \{}
\DoxyCodeLine{103             \textcolor{keyword}{const} \textcolor{keyword}{auto}\& top = s\_queue-\/>top();}
\DoxyCodeLine{104 }
\DoxyCodeLine{105             wait\_and\_extract\_executable\_if\_subscribed(top, function);}
\DoxyCodeLine{106 }
\DoxyCodeLine{107             \textcolor{comment}{// firstly we need to pop schedulable from queue due to execution of function can add new schedulable}}
\DoxyCodeLine{108             s\_queue-\/>pop();}
\DoxyCodeLine{109 }
\DoxyCodeLine{110             \textcolor{keywordflow}{if} (function)}
\DoxyCodeLine{111                 (*function)();}
\DoxyCodeLine{112 }
\DoxyCodeLine{113             function.reset();}
\DoxyCodeLine{114         \}}
\DoxyCodeLine{115     \}}
\DoxyCodeLine{116 }
\DoxyCodeLine{117     \textcolor{keyword}{static} \textcolor{keywordtype}{void} wait\_and\_extract\_executable\_if\_subscribed(\textcolor{keyword}{const} current\_thread\_schedulable\& schedulable, std::optional<trampoline\_schedulable>\& out)}
\DoxyCodeLine{118     \{}
\DoxyCodeLine{119         \textcolor{keywordflow}{if} (!schedulable.is\_subscribed())}
\DoxyCodeLine{120             \textcolor{keywordflow}{return};}
\DoxyCodeLine{121 }
\DoxyCodeLine{122         \textcolor{comment}{// wait only if needed!}}
\DoxyCodeLine{123         \textcolor{keywordflow}{if} (\textcolor{keyword}{const} \textcolor{keyword}{auto} requested\_time = schedulable.get\_time\_point(); details::s\_last\_sleep\_timepoint < requested\_time)}
\DoxyCodeLine{124         \{}
\DoxyCodeLine{125             std::this\_thread::sleep\_until(requested\_time);}
\DoxyCodeLine{126             details::s\_last\_sleep\_timepoint = requested\_time;}
\DoxyCodeLine{127 }
\DoxyCodeLine{128             \textcolor{keywordflow}{if} (!schedulable.is\_subscribed())}
\DoxyCodeLine{129                 \textcolor{keywordflow}{return};}
\DoxyCodeLine{130         \}}
\DoxyCodeLine{131 }
\DoxyCodeLine{132         out.emplace(std::move(schedulable.extract\_function()));}
\DoxyCodeLine{133     \}}
\DoxyCodeLine{134 }
\DoxyCodeLine{135     \textcolor{keyword}{class }current\_thread\_schedulable : \textcolor{keyword}{public} \mbox{\hyperlink{classrpp_1_1schedulers_1_1details_1_1schedulable}{details::schedulable}}<trampoline\_schedulable>}
\DoxyCodeLine{136     \{}
\DoxyCodeLine{137     \textcolor{keyword}{public}:}
\DoxyCodeLine{138         current\_thread\_schedulable(time\_point                  time\_point,}
\DoxyCodeLine{139                                    std::invocable \textcolor{keyword}{auto}\&\&       fn,}
\DoxyCodeLine{140                                    \mbox{\hyperlink{classrpp_1_1composite__subscription}{rpp::composite\_subscription}} subscription)}
\DoxyCodeLine{141             : schedulable(time\_point, get\_thread\_local\_id(), std::forward<\textcolor{keyword}{decltype}(fn)>(fn))}
\DoxyCodeLine{142             , m\_subscription\{std::move(subscription)\} \{\}}
\DoxyCodeLine{143 }
\DoxyCodeLine{144         \textcolor{keywordtype}{bool} is\_subscribed()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} m\_subscription.is\_subscribed(); \}}
\DoxyCodeLine{145 }
\DoxyCodeLine{146     \textcolor{keyword}{private}:}
\DoxyCodeLine{147         \textcolor{keyword}{static} \textcolor{keywordtype}{size\_t} get\_thread\_local\_id()}
\DoxyCodeLine{148         \{}
\DoxyCodeLine{149             \textcolor{keyword}{static} \textcolor{keyword}{thread\_local} \textcolor{keywordtype}{size\_t} s\_id;}
\DoxyCodeLine{150             \textcolor{keywordflow}{return} s\_id++;}
\DoxyCodeLine{151         \}}
\DoxyCodeLine{152 }
\DoxyCodeLine{153     \textcolor{keyword}{private}:}
\DoxyCodeLine{154         \mbox{\hyperlink{classrpp_1_1composite__subscription}{rpp::composite\_subscription}} m\_subscription\{\};}
\DoxyCodeLine{155     \};}
\DoxyCodeLine{156 }
\DoxyCodeLine{160     \textcolor{keyword}{inline} \textcolor{keyword}{static} \textcolor{keyword}{thread\_local} std::optional<std::priority\_queue<current\_thread\_schedulable>> s\_queue\{\};}
\DoxyCodeLine{161 }
\DoxyCodeLine{162 \textcolor{keyword}{public}:}
\DoxyCodeLine{163     \textcolor{keyword}{static} utils::finally\_action<void (*)()> own\_queue\_and\_drain\_finally\_if\_not\_owned()}
\DoxyCodeLine{164     \{}
\DoxyCodeLine{165         \textcolor{keyword}{const} \textcolor{keywordtype}{bool} someone\_owns\_queue = s\_queue.has\_value();}
\DoxyCodeLine{166 }
\DoxyCodeLine{167         \textcolor{keywordflow}{if} (!someone\_owns\_queue)}
\DoxyCodeLine{168             s\_queue = std::priority\_queue<current\_thread\_schedulable>\{\};}
\DoxyCodeLine{169 }
\DoxyCodeLine{170         \textcolor{keywordflow}{return} \{!someone\_owns\_queue ? \&drain\_queue : +[] \{\}\};}
\DoxyCodeLine{171     \}}
\DoxyCodeLine{172 }
\DoxyCodeLine{173     \textcolor{keyword}{static} \textcolor{keyword}{auto} create\_worker(\textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1composite__subscription}{rpp::composite\_subscription}}\& sub = \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\{\})}
\DoxyCodeLine{174     \{}
\DoxyCodeLine{175         \textcolor{keywordflow}{return} \mbox{\hyperlink{classrpp_1_1schedulers_1_1worker}{worker<worker\_strategy>}}\{sub\};}
\DoxyCodeLine{176     \}}
\DoxyCodeLine{177 \};}
\DoxyCodeLine{178 \} \textcolor{comment}{// namespace rpp::schedulers}}

\end{DoxyCode}
