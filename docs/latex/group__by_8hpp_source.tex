\hypertarget{group__by_8hpp_source}{}\doxysection{group\+\_\+by.\+hpp}
\label{group__by_8hpp_source}\index{src/rpp/rpp/operators/group\_by.hpp@{src/rpp/rpp/operators/group\_by.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{2 }
\DoxyCodeLine{3 \textcolor{preprocessor}{\#include <rpp/defs.hpp>}                                    \textcolor{comment}{// RPP\_NO\_UNIQUE\_ADDRESS}}
\DoxyCodeLine{4 \textcolor{preprocessor}{\#include <rpp/observables/grouped\_observable.hpp>}          \textcolor{comment}{// grouped\_observable}}
\DoxyCodeLine{5 \textcolor{preprocessor}{\#include <rpp/operators/lift.hpp>}                          \textcolor{comment}{// required due to operator uses lift}}
\DoxyCodeLine{6 \textcolor{preprocessor}{\#include <rpp/operators/details/subscriber\_with\_state.hpp>} \textcolor{comment}{// create\_subscriber\_with\_state}}
\DoxyCodeLine{7 \textcolor{preprocessor}{\#include <rpp/operators/fwd/group\_by.hpp>}                  \textcolor{comment}{// own forwarding}}
\DoxyCodeLine{8 \textcolor{preprocessor}{\#include <rpp/subjects/publish\_subject.hpp>}                \textcolor{comment}{// publish\_subject}}
\DoxyCodeLine{9 \textcolor{preprocessor}{\#include <rpp/subscribers/constraints.hpp>}                 \textcolor{comment}{// constraint::subscriber}}
\DoxyCodeLine{10 \textcolor{preprocessor}{\#include <rpp/utils/utilities.hpp>}                         \textcolor{comment}{// utils::as\_const}}
\DoxyCodeLine{11 }
\DoxyCodeLine{12 \textcolor{preprocessor}{\#include <atomic>}}
\DoxyCodeLine{13 \textcolor{preprocessor}{\#include <map>}}
\DoxyCodeLine{14 }
\DoxyCodeLine{15 IMPLEMENTATION\_FILE(group\_by\_tag);}
\DoxyCodeLine{16 }
\DoxyCodeLine{17 \textcolor{keyword}{namespace }rpp::details}
\DoxyCodeLine{18 \{}
\DoxyCodeLine{19 \textcolor{keyword}{class }\mbox{\hyperlink{classrpp_1_1details_1_1group__by__state__base}{group\_by\_state\_base}} : \textcolor{keyword}{public} std::enable\_shared\_from\_this<group\_by\_state\_base>}
\DoxyCodeLine{20 \{}
\DoxyCodeLine{21 \textcolor{keyword}{public}:}
\DoxyCodeLine{22     \mbox{\hyperlink{classrpp_1_1details_1_1group__by__state__base}{group\_by\_state\_base}}() = \textcolor{keywordflow}{default};}
\DoxyCodeLine{23 }
\DoxyCodeLine{24     \textcolor{keyword}{virtual} \mbox{\hyperlink{classrpp_1_1details_1_1group__by__state__base}{\string~group\_by\_state\_base}}() \textcolor{keyword}{noexcept} = \textcolor{keywordflow}{default};}
\DoxyCodeLine{25 }
\DoxyCodeLine{26     \textcolor{keywordtype}{void} on\_subscribe(\textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\& dest)}
\DoxyCodeLine{27     \{}
\DoxyCodeLine{28         subscribers.fetch\_add(1, std::memory\_order::acq\_rel);}
\DoxyCodeLine{29         dest.\mbox{\hyperlink{classrpp_1_1composite__subscription_aee6a1f22ecbfa2f1dce0b63f20084b99}{add}}([state = this-\/>weak\_from\_this()]}
\DoxyCodeLine{30                  \{}
\DoxyCodeLine{31                      \textcolor{keywordflow}{if} (\textcolor{keyword}{const} \textcolor{keyword}{auto} locked = state.lock())}
\DoxyCodeLine{32                          if (locked-\/>subscribers.fetch\_sub(1, std::memory\_order::acq\_rel) == 1)}
\DoxyCodeLine{33                              locked-\/>lifetime.unsubscribe();}
\DoxyCodeLine{34                  \});}
\DoxyCodeLine{35     \}}
\DoxyCodeLine{36 }
\DoxyCodeLine{37     \textcolor{keyword}{const} \textcolor{keyword}{auto}\& get\_source\_lifetime()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} lifetime; \}}
\DoxyCodeLine{38 }
\DoxyCodeLine{39 \textcolor{keyword}{private}:}
\DoxyCodeLine{40     \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}} lifetime\{\};}
\DoxyCodeLine{41     std::atomic\_size\_t     subscribers\{\};}
\DoxyCodeLine{42 \};}
\DoxyCodeLine{43 }
\DoxyCodeLine{44 \textcolor{keyword}{template}<constra\textcolor{keywordtype}{int}::decayed\_type TKey, constra\textcolor{keywordtype}{int}::decayed\_type Type, std::strict\_weak\_order<TKey, TKey> KeyComparator>}
\DoxyCodeLine{45 \textcolor{keyword}{struct }\mbox{\hyperlink{structrpp_1_1details_1_1group__by__state}{group\_by\_state}} final : \mbox{\hyperlink{classrpp_1_1details_1_1group__by__state__base}{group\_by\_state\_base}}}
\DoxyCodeLine{46 \{}
\DoxyCodeLine{47     \mbox{\hyperlink{structrpp_1_1details_1_1group__by__state}{group\_by\_state}}(\textcolor{keyword}{const} KeyComparator\& comparator)}
\DoxyCodeLine{48         : \mbox{\hyperlink{classrpp_1_1details_1_1group__by__state__base}{group\_by\_state\_base}}\{\}}
\DoxyCodeLine{49         , key\_to\_subject\{comparator\} \{ \}}
\DoxyCodeLine{50 }
\DoxyCodeLine{51     std::map<TKey, subjects::publish\_subject<Type>, KeyComparator> key\_to\_subject;}
\DoxyCodeLine{52 }
\DoxyCodeLine{53     \textcolor{keywordtype}{void} broadcast(\textcolor{keyword}{const} \textcolor{keyword}{auto}\& action, \textcolor{keyword}{const} \textcolor{keyword}{auto}\& subscriber)\textcolor{keyword}{ const}}
\DoxyCodeLine{54 \textcolor{keyword}{    }\{}
\DoxyCodeLine{55         \textcolor{keywordflow}{for} (\textcolor{keyword}{const} \textcolor{keyword}{auto}\& [\_, subject] : key\_to\_subject)}
\DoxyCodeLine{56             action(subject.get\_subscriber());}
\DoxyCodeLine{57 }
\DoxyCodeLine{58         action(subscriber);}
\DoxyCodeLine{59     \}}
\DoxyCodeLine{60 \};}
\DoxyCodeLine{61 }
\DoxyCodeLine{62 \textcolor{keyword}{template}<constra\textcolor{keywordtype}{int}::decayed\_type Type>}
\DoxyCodeLine{63 \textcolor{keyword}{struct }\mbox{\hyperlink{structrpp_1_1details_1_1group__by__on__subscribe}{group\_by\_on\_subscribe}}}
\DoxyCodeLine{64 \{}
\DoxyCodeLine{65     \mbox{\hyperlink{classrpp_1_1subjects_1_1publish__subject}{subjects::publish\_subject<Type>}}    subject;}
\DoxyCodeLine{66     std::weak\_ptr<group\_by\_state\_base> state;}
\DoxyCodeLine{67 }
\DoxyCodeLine{68     \textcolor{keywordtype}{void} operator()(\textcolor{keyword}{auto}\&\& subscriber)\textcolor{keyword}{ const}}
\DoxyCodeLine{69 \textcolor{keyword}{    }\{}
\DoxyCodeLine{70         \textcolor{keywordflow}{if} (\textcolor{keyword}{const} \textcolor{keyword}{auto} locked = state.lock())}
\DoxyCodeLine{71         \{}
\DoxyCodeLine{72             locked-\/>on\_subscribe(subscriber.get\_subscription());}
\DoxyCodeLine{73             subject.get\_observable().subscribe(std::forward<\textcolor{keyword}{decltype}(subscriber)>(subscriber));}
\DoxyCodeLine{74         \}}
\DoxyCodeLine{75     \}}
\DoxyCodeLine{76 \};}
\DoxyCodeLine{77 \} \textcolor{comment}{// namespace rpp::details}}
\DoxyCodeLine{78 }
\DoxyCodeLine{79 \textcolor{keyword}{namespace }rpp}
\DoxyCodeLine{80 \{}
\DoxyCodeLine{81 \textcolor{keyword}{template}<constra\textcolor{keywordtype}{int}::decayed\_type TKey, constra\textcolor{keywordtype}{int}::decayed\_type ResValue>}
\DoxyCodeLine{82 \textcolor{keyword}{using }\mbox{\hyperlink{classrpp_1_1grouped__observable}{grouped\_observable\_group\_by}} = \mbox{\hyperlink{classrpp_1_1grouped__observable}{grouped\_observable<TKey, ResValue, details::group\_by\_on\_subscribe<ResValue>}}>;}
\DoxyCodeLine{83 \}}
\DoxyCodeLine{84 }
\DoxyCodeLine{85 \textcolor{keyword}{namespace }rpp::details}
\DoxyCodeLine{86 \{}
\DoxyCodeLine{87 \textcolor{keyword}{template}<constraint::decayed\_type           Type,}
\DoxyCodeLine{88          constraint::decayed\_type           TKey,}
\DoxyCodeLine{89          std::invocable<Type>               KeySelector,}
\DoxyCodeLine{90          std::invocable<Type>               ValueSelector,}
\DoxyCodeLine{91          std::strict\_weak\_order<TKey, TKey> KeyComparator>}
\DoxyCodeLine{92 \textcolor{keyword}{struct }\mbox{\hyperlink{structrpp_1_1details_1_1group__by__lift__impl}{group\_by\_lift\_impl}}}
\DoxyCodeLine{93 \{}
\DoxyCodeLine{94     \textcolor{keyword}{using }ValueType = utils::decayed\_invoke\_result\_t<ValueSelector, Type>;}
\DoxyCodeLine{95     \textcolor{keyword}{using }\mbox{\hyperlink{structrpp_1_1details_1_1group__by__state}{StateType}} = \mbox{\hyperlink{structrpp_1_1details_1_1group__by__state}{group\_by\_state<TKey, utils::decayed\_invoke\_result\_t<ValueSelector, Type>}}, KeyComparator>;}
\DoxyCodeLine{96 }
\DoxyCodeLine{97     RPP\_NO\_UNIQUE\_ADDRESS KeySelector   key\_selector;}
\DoxyCodeLine{98     RPP\_NO\_UNIQUE\_ADDRESS ValueSelector value\_selector;}
\DoxyCodeLine{99     RPP\_NO\_UNIQUE\_ADDRESS KeyComparator comparator;}
\DoxyCodeLine{100 }
\DoxyCodeLine{101 \textcolor{keyword}{private}:}
\DoxyCodeLine{102     \textcolor{keyword}{struct }observer\_state}
\DoxyCodeLine{103     \{}
\DoxyCodeLine{104         std::shared\_ptr<StateType>          state;}
\DoxyCodeLine{105         RPP\_NO\_UNIQUE\_ADDRESS KeySelector   key\_selector;}
\DoxyCodeLine{106         RPP\_NO\_UNIQUE\_ADDRESS ValueSelector value\_selector;}
\DoxyCodeLine{107     \};}
\DoxyCodeLine{108 }
\DoxyCodeLine{109     \textcolor{keyword}{struct }on\_next}
\DoxyCodeLine{110     \{}
\DoxyCodeLine{111         \textcolor{keywordtype}{void} operator()(\textcolor{keyword}{auto}\&\& val, \textcolor{keyword}{const} \textcolor{keyword}{auto}\& subscriber, \textcolor{keyword}{const} observer\_state\& state)\textcolor{keyword}{ const}}
\DoxyCodeLine{112 \textcolor{keyword}{        }\{}
\DoxyCodeLine{113             \textcolor{keyword}{auto} key             = state.key\_selector(utils::as\_const(val));}
\DoxyCodeLine{114             \textcolor{keyword}{auto} [itr, inserted] = state.state-\/>key\_to\_subject.try\_emplace(key);}
\DoxyCodeLine{115 }
\DoxyCodeLine{116             \textcolor{keywordflow}{if} (inserted)}
\DoxyCodeLine{117                 subscriber.on\_next(\mbox{\hyperlink{classrpp_1_1grouped__observable}{grouped\_observable\_group\_by<TKey, ValueType>}}\{key, \mbox{\hyperlink{structrpp_1_1details_1_1group__by__on__subscribe}{group\_by\_on\_subscribe<ValueType>}}\{itr-\/>second, state.state\}\});}
\DoxyCodeLine{118 }
\DoxyCodeLine{119             \textcolor{keyword}{const} \textcolor{keyword}{auto}\& subject\_sub = itr-\/>second.get\_subscriber();}
\DoxyCodeLine{120             \textcolor{keywordflow}{if} (subject\_sub.is\_subscribed())}
\DoxyCodeLine{121                 subject\_sub.on\_next(state.value\_selector(std::forward<\textcolor{keyword}{decltype}(val)>(val)));}
\DoxyCodeLine{122         \}}
\DoxyCodeLine{123     \};}
\DoxyCodeLine{124 }
\DoxyCodeLine{125     \textcolor{keyword}{struct }on\_error}
\DoxyCodeLine{126     \{}
\DoxyCodeLine{127         \textcolor{keywordtype}{void} operator()(\textcolor{keyword}{const} std::exception\_ptr\& err, \textcolor{keyword}{const} \textcolor{keyword}{auto}\& subscriber, \textcolor{keyword}{const} observer\_state\& state)\textcolor{keyword}{ const}}
\DoxyCodeLine{128 \textcolor{keyword}{        }\{}
\DoxyCodeLine{129             state.state-\/>broadcast([\&err](\textcolor{keyword}{const} \textcolor{keyword}{auto}\& sub) \{ sub.on\_error(err); \}, subscriber);}
\DoxyCodeLine{130         \}}
\DoxyCodeLine{131     \};}
\DoxyCodeLine{132 }
\DoxyCodeLine{133     \textcolor{keyword}{struct }on\_completed}
\DoxyCodeLine{134     \{}
\DoxyCodeLine{135         \textcolor{keywordtype}{void} operator()(\textcolor{keyword}{const} \textcolor{keyword}{auto}\& subscriber, \textcolor{keyword}{const} observer\_state\& state)\textcolor{keyword}{ const}}
\DoxyCodeLine{136 \textcolor{keyword}{        }\{}
\DoxyCodeLine{137             state.state-\/>broadcast([](\textcolor{keyword}{const} \textcolor{keyword}{auto}\& sub) \{ sub.on\_completed(); \}, subscriber);}
\DoxyCodeLine{138         \}}
\DoxyCodeLine{139     \};}
\DoxyCodeLine{140 }
\DoxyCodeLine{141 \textcolor{keyword}{public}:}
\DoxyCodeLine{142     \textcolor{keyword}{template}<constra\textcolor{keywordtype}{int}::subscriber TSub>}
\DoxyCodeLine{143     \textcolor{keyword}{auto} operator()(TSub\&\& subscriber)\textcolor{keyword}{ const}}
\DoxyCodeLine{144 \textcolor{keyword}{    }\{}
\DoxyCodeLine{145         \textcolor{keyword}{auto} state = std::make\_shared<StateType>(comparator);}
\DoxyCodeLine{146 }
\DoxyCodeLine{147         state-\/>on\_subscribe(subscriber.get\_subscription());}
\DoxyCodeLine{148 }
\DoxyCodeLine{149         \textcolor{keywordflow}{return} create\_subscriber\_with\_state<Type>(state-\/>get\_source\_lifetime(),}
\DoxyCodeLine{150                                                   on\_next\{\},}
\DoxyCodeLine{151                                                   on\_error\{\},}
\DoxyCodeLine{152                                                   on\_completed\{\},}
\DoxyCodeLine{153                                                   std::forward<TSub>(subscriber),}
\DoxyCodeLine{154                                                   observer\_state\{state, key\_selector, value\_selector\});}
\DoxyCodeLine{155     \}}
\DoxyCodeLine{156 \};}
\DoxyCodeLine{157 }
\DoxyCodeLine{158 \textcolor{keyword}{template}<constraint::decayed\_type           Type,}
\DoxyCodeLine{159          constraint::decayed\_type           TKey,}
\DoxyCodeLine{160          std::invocable<Type>               KeySelector,}
\DoxyCodeLine{161          std::invocable<Type>               ValueSelector,}
\DoxyCodeLine{162          std::strict\_weak\_order<TKey, TKey> KeyComparator>}
\DoxyCodeLine{163 \textcolor{keyword}{auto} group\_by\_impl(\textcolor{keyword}{auto}\&\& observable, KeySelector\&\& key\_selector, ValueSelector\&\& value\_selector, KeyComparator\&\& comparator)}
\DoxyCodeLine{164 \{}
\DoxyCodeLine{165     \textcolor{keyword}{using }Res = \mbox{\hyperlink{classrpp_1_1grouped__observable}{grouped\_observable\_group\_by<TKey, utils::decayed\_invoke\_result\_t<ValueSelector, Type>}}>;}
\DoxyCodeLine{166     \textcolor{keyword}{using }Lifter = \mbox{\hyperlink{structrpp_1_1details_1_1group__by__lift__impl}{group\_by\_lift\_impl<Type, TKey, std::decay\_t<KeySelector>}}, std::decay\_t<ValueSelector>, std::decay\_t<KeyComparator>>;}
\DoxyCodeLine{167 }
\DoxyCodeLine{168     \textcolor{keywordflow}{return} std::forward<decltype(observable)>(observable)}
\DoxyCodeLine{169         .template lift<Res>(Lifter\{std::forward<KeySelector>(key\_selector),}
\DoxyCodeLine{170                                    std::forward<ValueSelector>(value\_selector),}
\DoxyCodeLine{171                                    std::forward<KeyComparator>(comparator)\});}
\DoxyCodeLine{172 \}}
\DoxyCodeLine{173 \} \textcolor{comment}{// namespace rpp::details}}

\end{DoxyCode}
