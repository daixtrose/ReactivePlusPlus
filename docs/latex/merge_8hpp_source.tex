\hypertarget{merge_8hpp_source}{}\doxysection{merge.\+hpp}
\label{merge_8hpp_source}\index{src/rpp/rpp/operators/merge.hpp@{src/rpp/rpp/operators/merge.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{//                  ReactivePlusPlus library}}
\DoxyCodeLine{2 \textcolor{comment}{//}}
\DoxyCodeLine{3 \textcolor{comment}{//          Copyright Aleksey Loginov 2022 -\/ present.}}
\DoxyCodeLine{4 \textcolor{comment}{// Distributed under the Boost Software License, Version 1.0.}}
\DoxyCodeLine{5 \textcolor{comment}{//    (See accompanying file LICENSE\_1\_0.txt or copy at}}
\DoxyCodeLine{6 \textcolor{comment}{//          https://www.boost.org/LICENSE\_1\_0.txt)}}
\DoxyCodeLine{7 \textcolor{comment}{//}}
\DoxyCodeLine{8 \textcolor{comment}{// Project home: https://github.com/victimsnino/ReactivePlusPlus}}
\DoxyCodeLine{9 \textcolor{comment}{//}}
\DoxyCodeLine{10 }
\DoxyCodeLine{11 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{12 }
\DoxyCodeLine{13 \textcolor{preprocessor}{\#include <rpp/schedulers/immediate\_scheduler.hpp>}}
\DoxyCodeLine{14 \textcolor{preprocessor}{\#include <rpp/operators/lift.hpp>}                           \textcolor{comment}{// required due to operator uses lift}}
\DoxyCodeLine{15 \textcolor{preprocessor}{\#include <rpp/operators/details/early\_unsubscribe.hpp>}      \textcolor{comment}{// early\_unsubscribe}}
\DoxyCodeLine{16 \textcolor{preprocessor}{\#include <rpp/operators/details/serialized\_subscriber.hpp>}  \textcolor{comment}{// make\_serialized\_subscriber}}
\DoxyCodeLine{17 \textcolor{preprocessor}{\#include <rpp/operators/details/subscriber\_with\_state.hpp>}  \textcolor{comment}{// create\_subscriber\_with\_state}}
\DoxyCodeLine{18 \textcolor{preprocessor}{\#include <rpp/operators/fwd/merge.hpp>}                      \textcolor{comment}{// own forwarding}}
\DoxyCodeLine{19 \textcolor{preprocessor}{\#include <rpp/sources/just.hpp>}                             \textcolor{comment}{// just}}
\DoxyCodeLine{20 \textcolor{preprocessor}{\#include <rpp/subscribers/constraints.hpp>}                  \textcolor{comment}{// constraint::subscriber}}
\DoxyCodeLine{21 \textcolor{preprocessor}{\#include <rpp/utils/functors.hpp>}                           \textcolor{comment}{// forwarding\_on\_next}}
\DoxyCodeLine{22 }
\DoxyCodeLine{23 \textcolor{preprocessor}{\#include <array>}}
\DoxyCodeLine{24 \textcolor{preprocessor}{\#include <atomic>}}
\DoxyCodeLine{25 \textcolor{preprocessor}{\#include <memory>}}
\DoxyCodeLine{26 }
\DoxyCodeLine{27 IMPLEMENTATION\_FILE(merge\_tag);}
\DoxyCodeLine{28 }
\DoxyCodeLine{29 \textcolor{keyword}{namespace }rpp::details}
\DoxyCodeLine{30 \{}
\DoxyCodeLine{31 \textcolor{keyword}{struct }\mbox{\hyperlink{structrpp_1_1details_1_1merge__state}{merge\_state}} : \mbox{\hyperlink{structrpp_1_1details_1_1early__unsubscribe__state}{early\_unsubscribe\_state}}}
\DoxyCodeLine{32 \{}
\DoxyCodeLine{33     \textcolor{keyword}{using }early\_unsubscribe\_state::early\_unsubscribe\_state;}
\DoxyCodeLine{34 }
\DoxyCodeLine{35     std::atomic\_size\_t count\_of\_on\_completed\_needed\{\};}
\DoxyCodeLine{36 \};}
\DoxyCodeLine{37 }
\DoxyCodeLine{38 \textcolor{keyword}{using }merge\_forwarding\_on\_next = utils::forwarding\_on\_next;}
\DoxyCodeLine{39 \textcolor{keyword}{using }\mbox{\hyperlink{structrpp_1_1details_1_1early__unsubscribe__on__error}{merge\_on\_error}}           = \mbox{\hyperlink{structrpp_1_1details_1_1early__unsubscribe__on__error}{early\_unsubscribe\_on\_error}};}
\DoxyCodeLine{40 }
\DoxyCodeLine{41 \textcolor{keyword}{struct }\mbox{\hyperlink{structrpp_1_1details_1_1merge__on__completed}{merge\_on\_completed}}}
\DoxyCodeLine{42 \{}
\DoxyCodeLine{43     \textcolor{keywordtype}{void} operator()(\textcolor{keyword}{const} \mbox{\hyperlink{conceptrpp_1_1constraint_1_1subscriber}{constraint::subscriber}} \textcolor{keyword}{auto}\&  sub,}
\DoxyCodeLine{44                     \textcolor{keyword}{const} std::shared\_ptr<merge\_state>\& state)\textcolor{keyword}{ const}}
\DoxyCodeLine{45 \textcolor{keyword}{    }\{}
\DoxyCodeLine{46         \textcolor{keywordflow}{if} (state-\/>count\_of\_on\_completed\_needed.fetch\_sub(1, std::memory\_order::acq\_rel) == 1)}
\DoxyCodeLine{47             sub.on\_completed();}
\DoxyCodeLine{48     \}}
\DoxyCodeLine{49 \};}
\DoxyCodeLine{50 }
\DoxyCodeLine{51 \textcolor{keyword}{struct }\mbox{\hyperlink{structrpp_1_1details_1_1merge__on__next}{merge\_on\_next}}}
\DoxyCodeLine{52 \{}
\DoxyCodeLine{53     \textcolor{keyword}{template}<constra\textcolor{keywordtype}{int}::observable TObs>}
\DoxyCodeLine{54     \textcolor{keywordtype}{void} operator()(\textcolor{keyword}{const} TObs\&                         new\_observable,}
\DoxyCodeLine{55                     \textcolor{keyword}{const} \mbox{\hyperlink{conceptrpp_1_1constraint_1_1subscriber}{constraint::subscriber}} \textcolor{keyword}{auto}\&  sub,}
\DoxyCodeLine{56                     \textcolor{keyword}{const} std::shared\_ptr<merge\_state>\& state)\textcolor{keyword}{ const}}
\DoxyCodeLine{57 \textcolor{keyword}{    }\{}
\DoxyCodeLine{58         \textcolor{keyword}{using }ValueType = utils::extract\_observable\_type\_t<TObs>;}
\DoxyCodeLine{59 }
\DoxyCodeLine{60         state-\/>count\_of\_on\_completed\_needed.fetch\_add(1, std::memory\_order::relaxed);}
\DoxyCodeLine{61 }
\DoxyCodeLine{62         new\_observable.subscribe(create\_subscriber\_with\_state<ValueType>(state-\/>children\_subscriptions.make\_child(),}
\DoxyCodeLine{63                                                                          merge\_forwarding\_on\_next\{\},}
\DoxyCodeLine{64                                                                          \mbox{\hyperlink{structrpp_1_1details_1_1early__unsubscribe__on__error}{merge\_on\_error}}\{\},}
\DoxyCodeLine{65                                                                          \mbox{\hyperlink{structrpp_1_1details_1_1merge__on__completed}{merge\_on\_completed}}\{\},}
\DoxyCodeLine{66                                                                          sub,}
\DoxyCodeLine{67                                                                          state));}
\DoxyCodeLine{68     \}}
\DoxyCodeLine{69 \};}
\DoxyCodeLine{70 }
\DoxyCodeLine{71 \textcolor{keyword}{struct }\mbox{\hyperlink{structrpp_1_1details_1_1merge__state__with__serialized__mutex}{merge\_state\_with\_serialized\_mutex}} : \mbox{\hyperlink{structrpp_1_1details_1_1merge__state}{merge\_state}}}
\DoxyCodeLine{72 \{}
\DoxyCodeLine{73     \textcolor{keyword}{using }merge\_state::merge\_state;}
\DoxyCodeLine{74 }
\DoxyCodeLine{75     std::mutex mutex\{\};}
\DoxyCodeLine{76 \};}
\DoxyCodeLine{77 }
\DoxyCodeLine{78 \textcolor{keyword}{template}<constra\textcolor{keywordtype}{int}::decayed\_type Type>}
\DoxyCodeLine{79 \textcolor{keyword}{struct }\mbox{\hyperlink{structrpp_1_1details_1_1merge__impl}{merge\_impl}}}
\DoxyCodeLine{80 \{}
\DoxyCodeLine{81     \textcolor{keyword}{using }ValueType = utils::extract\_observable\_type\_t<Type>;}
\DoxyCodeLine{82 }
\DoxyCodeLine{83     \textcolor{keyword}{template}<constra\textcolor{keywordtype}{int}::subscriber\_of\_type<ValueType> TSub>}
\DoxyCodeLine{84     \textcolor{keyword}{auto} operator()(TSub\&\& in\_subscriber)\textcolor{keyword}{ const}}
\DoxyCodeLine{85 \textcolor{keyword}{    }\{}
\DoxyCodeLine{86         \textcolor{keyword}{auto} state = std::make\_shared<merge\_state\_with\_serialized\_mutex>(in\_subscriber.get\_subscription());}
\DoxyCodeLine{87         \textcolor{comment}{// change subscriber to serialized to avoid manual using of mutex}}
\DoxyCodeLine{88         \textcolor{keyword}{auto} subscriber = make\_serialized\_subscriber(std::forward<TSub>(in\_subscriber), std::shared\_ptr<std::mutex>\{state, \&state-\/>mutex\});}
\DoxyCodeLine{89 }
\DoxyCodeLine{90         state-\/>count\_of\_on\_completed\_needed.fetch\_add(1, std::memory\_order::relaxed);}
\DoxyCodeLine{91 }
\DoxyCodeLine{92         \textcolor{keyword}{auto} subscription = state-\/>children\_subscriptions.make\_child();}
\DoxyCodeLine{93         \textcolor{keywordflow}{return} create\_subscriber\_with\_state<Type>(std::move(subscription),}
\DoxyCodeLine{94                                                   \mbox{\hyperlink{structrpp_1_1details_1_1merge__on__next}{merge\_on\_next}}\{\},}
\DoxyCodeLine{95                                                   \mbox{\hyperlink{structrpp_1_1details_1_1early__unsubscribe__on__error}{merge\_on\_error}}\{\},}
\DoxyCodeLine{96                                                   \mbox{\hyperlink{structrpp_1_1details_1_1merge__on__completed}{merge\_on\_completed}}\{\},}
\DoxyCodeLine{97                                                   std::move(subscriber),}
\DoxyCodeLine{98                                                   std::move(state));}
\DoxyCodeLine{99     \}}
\DoxyCodeLine{100 \};}
\DoxyCodeLine{101 }
\DoxyCodeLine{102 \textcolor{keyword}{template}<constra\textcolor{keywordtype}{int}::decayed\_type Type, constra\textcolor{keywordtype}{int}::observable\_of\_type<Type> ... TObservables>}
\DoxyCodeLine{103 \textcolor{keyword}{auto} merge\_with\_impl(TObservables\&\&... observables)}
\DoxyCodeLine{104 \{}
\DoxyCodeLine{105     \textcolor{keywordflow}{return} source::just(\mbox{\hyperlink{classrpp_1_1schedulers_1_1immediate}{rpp::schedulers::immediate}}\{\}, std::forward<TObservables>(observables).as\_dynamic()...).merge();}
\DoxyCodeLine{106 \}}
\DoxyCodeLine{107 \} \textcolor{comment}{// namespace rpp::details}}

\end{DoxyCode}
