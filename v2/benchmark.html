<html>

<head>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
</head>

<body>
    <input type="checkbox" class="expander" id="toggle"> Hide RxCpp data
    <div id="graphs" style="width: 100%"></div>
    <script>
        const checkbox = document.getElementById('toggle');
        if (localStorage.getItem('checkboxStatus') == "true")
            checkbox.checked = true;

        checkbox.addEventListener('change', (event) => {
            localStorage.setItem('checkboxStatus', checkbox.checked)
            window.location.reload();
        })

        fetch('benchmark_results.json')
            .then(res => res.json())
            .then(json => {
                var title = 'Addition';

                var groupBy = function(xs, key) {
                    return xs.reduce(function(rv, x) {
                        (rv[x[key]] = rv[x[key]] || []).push(x);
                        return rv;
                    }, {});
                };

                for (const [platform, platform_results] of Object.entries(json))  {
                    var platformDetails = document.createElement('details');
                    var platformSummary = document.createElement('summary');
                    platformSummary.innerHTML += "<h2 style='display:inline'>"+platform+"</h2>";
                    platformDetails.style.position = "relative";
                    platformDetails.style.width = "100%";

                    for (const [title, resultsPerTitle] of Object.entries(groupBy(platform_results, "title"))) {
                        var titleDetails = document.createElement('details');
                        var titleSummary = document.createElement('summary');
                        var graphDiv = document.createElement('div');
                        titleSummary.innerHTML += "<h3 style='display:inline'>"+title+"</h3>"
                        titleSummary.style.marginLeft = 15;
                        titleDetails.style.position = "relative";
                        titleDetails.style.width = "100%";
                        graphDiv.style.position = "relative";
                        graphDiv.style.width = "100%";
                        graphDiv.style.height = "50%";
                        graphDiv.style.borderWidth = 5;


                        var reduced = resultsPerTitle.reduce((seed, current)=>{
                            if (seed.keys.indexOf(current["commit"]) == -1) {
                                seed.keys.push(current["commit"]);
                                seed.names.push(current["commit"]+": " + current["commit_message"].slice(0, 20));
                            }
                            return seed;
                        }, {keys: [], names: []});
                        var commitKeys = reduced.keys;
                        var commitNames = reduced.names;
                        const takeLast = 30;

                        var resultsPerName = groupBy(resultsPerTitle, "name");

                        var d3colors = Plotly.d3.scale.category20();
                        var colorNum = 0;
                        var data = Object.entries(resultsPerName)
                                         .flatMap(([name, results], i) => {
                                            color = d3colors(colorNum);
                                            colorNum += 1;
                                            return Object.entries(groupBy(results, "source"))
                                                 .filter(([source, results]) => {
                                                    if (document.getElementById('toggle').checked) {
                                                        return source == "rpp";
                                                    }
                                                    return true;
                                                 })
                                                 .map(([source, results]) => {
                                                     return {
                                                         name: "#" + (i+1) + " [" + source + "] " + name,
                                                         x: results.map(v => commitKeys.indexOf(v["commit"])),
                                                         y: results.map(v => v["median(elapsed)"].toFixed(2)),
                                                         type: "scatter",
                                                         mode : "lines+markers",
                                                         line: {
                                                            dash: source == "rxcpp" ? "dot" : "line",
                                                            color: color
                                                         }
                                                     }
                                                 });
                                         });
                        titleDetails.graphDiv = graphDiv;
                        titleDetails.underlyingData = data;
                        titleDetails.commitNames = commitNames;
                        titleDetails.addEventListener("toggle", function(ev) {
                            Plotly.newPlot(ev.currentTarget.graphDiv,
                                      ev.currentTarget.underlyingData,
                                      {
                                          showlegend: true,
                                          hovermode: "x unified",
                                          yaxis: {
                                            title: 'ns/iter',
                                            autorange: true,
                                            rangemode: "tozero"
                                          },
                                          xaxis: {
                                            tickvals: [...Array(ev.currentTarget.commitNames.length).keys()],
                                            tickmode: "array",
                                            ticktext: ev.currentTarget.commitNames,
                                            tickangle: -30,
                                            range: [ev.currentTarget.commitNames.length-takeLast, ev.currentTarget.commitNames.length],
                                            rangeslider : {
                                                visible: true
                                            },
                                            tickfont: {
                                                size: 8
                                            }
                                          },
                                          autosize: true
                                      },
                                      { responsive: true });

                            $(ev.currentTarget.graphDiv).on('plotly_relayout', {underlyingData: structuredClone(ev.currentTarget.underlyingData), graphDiv: ev.currentTarget.graphDiv}, (event)=>{
                                const sliceMin = Math.floor(event.currentTarget.layout.xaxis.range[0]);
                                const sliceMax = Math.floor(event.currentTarget.layout.xaxis.range[1]) - 1;
                                const { min, max } = event.data.underlyingData.reduce((seed, v) => {
                                    let start = v["x"].indexOf(sliceMin);
                                    let end = v["x"].indexOf(sliceMax);
                                    if (end != -1 || start != -1) {
                                        if (end == -1)
                                            end = v["x"].length-1;
                                        if (start == -1)
                                            start = 0
                                    }
                                    return { min: Math.max(0, Math.min(...v["y"].slice(start, end), seed["min"]) -2), max: Math.max(...v["y"].slice(start, end), seed["max"]) +2 };
                                }, { min: Infinity, max: -Infinity });

                                if (event.currentTarget.layout.yaxis.range[0] != min || event.currentTarget.layout.yaxis.range[1] != max) {
                                    Plotly.relayout(event.data.graphDiv, {
                                        'yaxis.range': [min, max]
                                    });
                                }
                            });

                            window.dispatchEvent(new Event('resize'));
                        });

                        titleDetails.appendChild(graphDiv);
                        titleDetails.appendChild(titleSummary);
                        platformDetails.appendChild(titleDetails);
                    }

                    platformDetails.appendChild(platformSummary);
                    document.getElementById("graphs").appendChild(platformDetails);
                }

                window.dispatchEvent(new Event('resize'));
            });
    </script>
</body>

</html>
