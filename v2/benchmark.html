<html>

<head>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
    <div id="graphs" style="width: 100%"></div>
    <script>
        fetch('benchmark_results.json')
            .then(res => res.json())
            .then(json => {
                var title = 'Addition';

                var groupBy = function(xs, key) {
                    return xs.reduce(function(rv, x) {
                        (rv[x[key]] = rv[x[key]] || []).push(x);
                        return rv;
                    }, {});
                };

                for (const [platform, platform_results] of Object.entries(json))  {
                    var platformDetails = document.createElement('details');
                    var platformSummary = document.createElement('summary');
                    platformSummary.innerHTML += "<h2 style='display:inline'>"+platform+"</h2>";
                    platformDetails.style.position = "relative";
                    platformDetails.style.width = "100%";

                    for (const [title, resultsPerTitle] of Object.entries(groupBy(platform_results, "title"))) {
                        var titleDetails = document.createElement('details');
                        titleDetails.addEventListener("toggle", function() {
                            window.dispatchEvent(new Event('resize'));
                        });
                        var titleSummary = document.createElement('summary');
                        var graphDiv = document.createElement('div');
                        titleSummary.innerHTML += "<h3 style='display:inline'>"+title+"</h3>"
                        titleSummary.style.marginLeft = 15;
                        titleDetails.style.position = "relative";
                        titleDetails.style.width = "100%";
                        graphDiv.style.position = "relative";
                        graphDiv.style.width = "100%";
                        graphDiv.style.height = "50%";
                        graphDiv.style.borderWidth = 5;


                        var reduced = resultsPerTitle.reduce((seed, current)=>{
                            if (seed.keys.indexOf(current["commit"]) == -1) {
                                seed.keys.push(current["commit"]);
                                seed.names.push(current["commit"]+": " + current["commit_message"].slice(0, 10));
                            }
                            return seed;
                        }, {keys: [], names: []});
                        var commitKeys = reduced.keys;
                        var commitNames = reduced.names;

                        var resultsPerName = groupBy(resultsPerTitle, "name");
                        console.log(resultsPerName);

                        var data = Object.entries(resultsPerName)
                                         .flatMap(([name, results]) => {
                                             return Object.entries(groupBy(results, "source"))
                                                 .map(([source, results]) => {
                                                     return {
                                                         name: "[" + source + "] " + name,
                                                         x: results.map(v => commitKeys.indexOf(v["commit"])),
                                                         y: results.map(v => v["median(elapsed)"].toFixed(2)),
                                                         type: "scatter",
                                                         mode : "lines+markers",
                                                         line: {
                                                            dash: source == "rxcpp" ? "dot" : "line"
                                                         }
                                                     }
                                                 });
                                         });

                                         console.log(data);

                        Plotly.newPlot(graphDiv,
                                      data,
                                      {
                                          showlegend: true,
                                          hovermode: "x unified",
                                          yaxis: {
                                            title: 'ns/iter',
                                            autorange: true,
                                            rangemode: "tozero"
                                          },
                                          xaxis: {
                                            tickvals: [...Array(commitNames.length).keys()],
                                            tickmode: "array",
                                            ticktext: commitNames,
                                            tickangle: -30,
                                            autorange: true,
                                            rangeslider : {
                                                visible: true
                                            },
                                            tickfont: {
                                                size: 8
                                            }
                                          },
                                          autosize: true
                                      },
                                      { responsive: true });


                        titleDetails.appendChild(graphDiv);
                        titleDetails.appendChild(titleSummary);
                        platformDetails.appendChild(titleDetails);
                    }

                    platformDetails.appendChild(platformSummary);
                    document.getElementById("graphs").appendChild(platformDetails);
                }

                window.dispatchEvent(new Event('resize'));
            });
    </script>
</body>

</html>
